---
title: PostgreSQL
description: Guide complet PostgreSQL avec commandes psql et requ√™tes SQL avanc√©es
---

import { Tab, Tabs } from 'fumadocs-ui/components/tabs';

PostgreSQL est un syst√®me de gestion de base de donn√©es relationnelle open source puissant et extensible. Ce guide r√©pertorie les commandes essentielles et les bonnes pratiques.

---

## üöÄ Commandes psql

### Navigation et Connexion

| Commande                | Description                                      |
| ----------------------- | ------------------------------------------------ |
| `\l` ou `\list`         | Lister toutes les bases de donn√©es               |
| `\c nom_db`             | Se connecter √† une base de donn√©es               |
| `\c nom_db utilisateur` | Se connecter avec un utilisateur sp√©cifique      |
| `\conninfo`             | Afficher les informations de connexion actuelles |
| `\q`                    | Quitter le client psql                           |
| `\! clear`              | Effacer l'√©cran (Linux/Mac)                      |

### Exploration des Objets

| Commande        | Description                                     |
| --------------- | ----------------------------------------------- |
| `\dt`           | Lister les tables du sch√©ma courant             |
| `\dt+`          | Lister les tables avec taille et description    |
| `\d nom_table`  | Afficher la structure d'une table               |
| `\d+ nom_table` | Structure d√©taill√©e avec commentaires et taille |
| `\dn`           | Lister les sch√©mas                              |
| `\dn+`          | Lister les sch√©mas avec permissions             |
| `\dv`           | Lister les vues                                 |
| `\di`           | Lister les index                                |
| `\df`           | Lister les fonctions                            |
| `\du`           | Lister les utilisateurs (roles)                 |
| `\dp` ou `\z`   | Afficher les permissions des tables             |

### Options d'Affichage

| Commande            | Description                                         |
| ------------------- | --------------------------------------------------- |
| `\x`                | Activer/D√©sactiver l'affichage vertical (expanded)  |
| `\x auto`           | Mode vertical automatique selon la largeur          |
| `\pset null 'NULL'` | D√©finir l'affichage des valeurs NULL                |
| `\pset border 2`    | Afficher les bordures compl√®tes                     |
| `\timing`           | Activer/D√©sactiver l'affichage du temps d'ex√©cution |
| `\a`                | Basculer entre mode align√©/non align√©               |
| `\H`                | Activer/D√©sactiver le mode HTML                     |

### Historique et Aide

| Commande          | Description                                |
| ----------------- | ------------------------------------------ |
| `\h`              | Aide sur les commandes SQL                 |
| `\h nom_commande` | Aide sur une commande SQL sp√©cifique       |
| `\?`              | Aide sur les commandes psql                |
| `\s`              | Afficher l'historique des commandes        |
| `\s fichier`      | Sauvegarder l'historique dans un fichier   |
| `\i fichier.sql`  | Ex√©cuter un fichier SQL                    |
| `\e`              | Ouvrir l'√©diteur pour composer une requ√™te |
| `\ef fonction`    | √âditer une fonction                        |

## üìä Requ√™tes SQL Essentielles

<Tabs items={['DDL', 'DML', 'SELECT', 'JSON']}>
<Tab value="DDL">

### Data Definition Language

```sql
-- Cr√©er une base de donn√©es
CREATE DATABASE nom_base;

-- Cr√©er une table
CREATE TABLE utilisateurs (
    id SERIAL PRIMARY KEY,
    nom VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    date_creation TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Ajouter une colonne
ALTER TABLE utilisateurs ADD COLUMN age INTEGER;

-- Modifier une colonne
ALTER TABLE utilisateurs ALTER COLUMN nom TYPE VARCHAR(200);

-- Supprimer une colonne
ALTER TABLE utilisateurs DROP COLUMN age;

-- Cr√©er un index
CREATE INDEX idx_email ON utilisateurs(email);

-- Cr√©er une vue
CREATE VIEW utilisateurs_actifs AS
SELECT * FROM utilisateurs WHERE actif = true;
```

</Tab>
<Tab value="DML">

### Data Manipulation Language

```sql
-- Insertion simple
INSERT INTO utilisateurs (nom, email)
VALUES ('Jean Dupont', 'jean@example.com');

-- Insertion multiple
INSERT INTO utilisateurs (nom, email) VALUES
    ('Alice Martin', 'alice@example.com'),
    ('Bob Leroy', 'bob@example.com');

-- Insertion avec retour
INSERT INTO utilisateurs (nom, email)
VALUES ('Marie Claire', 'marie@example.com')
RETURNING id, nom;

-- Mise √† jour
UPDATE utilisateurs
SET email = 'nouveau@example.com'
WHERE id = 1;

-- Mise √† jour avec jointure
UPDATE commandes c
SET statut = 'livr√©'
FROM utilisateurs u
WHERE c.utilisateur_id = u.id
AND u.pays = 'France';

-- Suppression
DELETE FROM utilisateurs WHERE id = 5;

-- UPSERT (INSERT ON CONFLICT)
INSERT INTO utilisateurs (email, nom)
VALUES ('test@example.com', 'Test User')
ON CONFLICT (email)
DO UPDATE SET nom = EXCLUDED.nom;
```

</Tab>
<Tab value="SELECT">

### Requ√™tes SELECT Avanc√©es

```sql
-- WITH (CTE - Common Table Expression)
WITH ventes_mensuelles AS (
    SELECT
        DATE_TRUNC('month', date_vente) AS mois,
        SUM(montant) AS total
    FROM ventes
    GROUP BY DATE_TRUNC('month', date_vente)
)
SELECT * FROM ventes_mensuelles
WHERE total > 10000;

-- Window Functions
SELECT
    nom,
    departement,
    salaire,
    AVG(salaire) OVER (PARTITION BY departement) AS salaire_moyen_dept,
    RANK() OVER (PARTITION BY departement ORDER BY salaire DESC) AS rang
FROM employes;

-- GROUPING SETS
SELECT
    categorie,
    sous_categorie,
    SUM(prix) AS total
FROM produits
GROUP BY GROUPING SETS (
    (categorie, sous_categorie),
    (categorie),
    ()
);

-- Requ√™te r√©cursive
WITH RECURSIVE hierarchie AS (
    SELECT id, nom, manager_id, 1 AS niveau
    FROM employes
    WHERE manager_id IS NULL

    UNION ALL

    SELECT e.id, e.nom, e.manager_id, h.niveau + 1
    FROM employes e
    JOIN hierarchie h ON e.manager_id = h.id
)
SELECT * FROM hierarchie;
```

</Tab>
<Tab value="JSON">

### Manipulation JSON/JSONB

```sql
-- Cr√©er une table avec JSONB
CREATE TABLE evenements (
    id SERIAL PRIMARY KEY,
    donnees JSONB NOT NULL
);

-- Insertion de donn√©es JSON
INSERT INTO evenements (donnees) VALUES
    ('{"type": "click", "page": "/home", "user": {"id": 1, "name": "Alice"}}'),
    ('{"type": "view", "page": "/product", "user": {"id": 2, "name": "Bob"}}');

-- Requ√™tes sur JSON
-- Acc√®s simple
SELECT donnees->>'type' AS type_evenement FROM evenements;

-- Acc√®s imbriqu√©
SELECT donnees->'user'->>'name' AS nom_utilisateur FROM evenements;

-- Filtre avec op√©rateur @>
SELECT * FROM evenements
WHERE donnees @> '{"type": "click"}';

-- Agr√©gation JSON
SELECT jsonb_agg(donnees) FROM evenements;

-- Mise √† jour JSON
UPDATE evenements
SET donnees = jsonb_set(donnees, '{user,status}', '"active"')
WHERE id = 1;
```

</Tab>
</Tabs>

## üîß Administration

<Tabs items={['Utilisateurs & Permissions', 'Maintenance', 'Backup & Restore', 'Monitoring']}>
<Tab value="Utilisateurs & Permissions">

### Gestion des Utilisateurs et Permissions

```sql
-- Cr√©er un utilisateur
CREATE USER nom_utilisateur WITH PASSWORD 'mot_de_passe';

-- Cr√©er un r√¥le
CREATE ROLE nom_role;

-- Donner des privil√®ges
GRANT ALL PRIVILEGES ON DATABASE nom_db TO nom_utilisateur;
GRANT SELECT, INSERT ON TABLE nom_table TO nom_utilisateur;
GRANT USAGE ON SCHEMA nom_schema TO nom_utilisateur;

-- R√©voquer des privil√®ges
REVOKE INSERT ON TABLE nom_table FROM nom_utilisateur;

-- Modifier un utilisateur
ALTER USER nom_utilisateur WITH SUPERUSER;
ALTER USER nom_utilisateur WITH PASSWORD 'nouveau_mdp';

-- Attribuer un r√¥le
GRANT nom_role TO nom_utilisateur;

-- Lister les permissions
SELECT * FROM information_schema.role_table_grants
WHERE grantee = 'nom_utilisateur';
```

</Tab>
<Tab value="Maintenance">

### Maintenance et Optimisation

```sql
-- Analyser les statistiques
ANALYZE nom_table;
ANALYZE; -- Toute la base

-- VACUUM (nettoyer l'espace)
VACUUM nom_table;
VACUUM FULL nom_table; -- Plus agressif mais lock la table
VACUUM ANALYZE nom_table; -- Les deux en une fois

-- R√©indexer
REINDEX TABLE nom_table;
REINDEX DATABASE nom_db;

-- V√©rifier la taille
SELECT
    pg_size_pretty(pg_database_size('nom_db')) AS taille_db;

SELECT
    schemaname AS schema,
    tablename AS table,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS taille
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;

-- Identifier les requ√™tes lentes
SELECT
    query,
    calls,
    total_time,
    mean_time,
    max_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;
```

</Tab>
<Tab value="Backup & Restore">

### Sauvegarde et Restauration

```bash
# Backup complet d'une base
pg_dump nom_db > backup.sql
pg_dump -Fc nom_db > backup.dump  # Format custom (compress√©)

# Backup avec options
pg_dump -h localhost -U utilisateur -d nom_db -f backup.sql

# Backup d'une table sp√©cifique
pg_dump -t nom_table nom_db > table_backup.sql

# Backup sch√©ma uniquement
pg_dump -s nom_db > schema.sql

# Backup donn√©es uniquement
pg_dump -a nom_db > data.sql

# Restauration
psql nom_db < backup.sql

# Restauration format custom
pg_restore -d nom_db backup.dump

# Backup de toutes les bases
pg_dumpall > all_databases.sql

# Restauration avec pg_restore
pg_restore -h localhost -U utilisateur -d nom_db -v backup.dump
```

</Tab>
<Tab value="Monitoring">

### Monitoring et Diagnostics

```sql
-- Connexions actives
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query
FROM pg_stat_activity
WHERE state != 'idle';

-- Tuer une connexion
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE pid = 12345;

-- Locks actifs
SELECT
    l.pid,
    a.usename,
    l.locktype,
    l.mode,
    l.granted,
    a.query
FROM pg_locks l
JOIN pg_stat_activity a ON l.pid = a.pid
WHERE NOT l.granted;

-- Cache hit ratio
SELECT
    sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)) AS cache_hit_ratio
FROM pg_statio_user_tables;

-- Tables les plus volumineuses
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS taille
FROM pg_stat_user_tables
ORDER BY pg_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;
```

</Tab>
</Tabs>

## üí° Tips & Bonnes Pratiques

<Tabs items={['Performance', 'S√©curit√©', 'D√©veloppement']}>
<Tab value="Performance">

### Optimisation des Performances

1. **Indexes**

   - Cr√©ez des indexes sur les colonnes utilis√©es dans WHERE, JOIN, ORDER BY
   - Utilisez `EXPLAIN ANALYZE` pour analyser vos requ√™tes
   - √âvitez les indexes inutiles (co√ªt de maintenance)

2. **Requ√™tes**

   ```sql
   -- Utiliser EXPLAIN pour analyser
   EXPLAIN ANALYZE SELECT * FROM table WHERE condition;

   -- √âviter SELECT *
   SELECT col1, col2 FROM table;  -- Mieux que SELECT *

   -- Utiliser LIMIT pour les tests
   SELECT * FROM grande_table LIMIT 100;
   ```

3. **Configuration**
   - Ajustez `shared_buffers` (g√©n√©ralement 25% de la RAM)
   - Configurez `work_mem` pour les tris et jointures
   - Activez `pg_stat_statements` pour le monitoring

</Tab>
<Tab value="S√©curit√©">

### Bonnes Pratiques de S√©curit√©

1. **Authentification**

   - Utilisez toujours des mots de passe forts
   - Configurez `pg_hba.conf` correctement
   - Pr√©f√©rez l'authentification par certificat en production

2. **Permissions**

   ```sql
   -- Principe du moindre privil√®ge
   REVOKE ALL ON SCHEMA public FROM PUBLIC;

   -- Cr√©er des r√¥les sp√©cifiques
   CREATE ROLE lecture_seule;
   GRANT SELECT ON ALL TABLES IN SCHEMA public TO lecture_seule;
   ```

3. **Chiffrement**
   - Activez SSL/TLS pour les connexions
   - Utilisez `pgcrypto` pour chiffrer les donn√©es sensibles

</Tab>
<Tab value="D√©veloppement">

### Tips pour le D√©veloppement

1. **Transactions**

   ```sql
   BEGIN;
   -- Vos op√©rations
   SAVEPOINT mon_savepoint;
   -- Op√©ration risqu√©e
   ROLLBACK TO mon_savepoint;  -- Si erreur
   COMMIT;  -- Si tout va bien
   ```

2. **Contraintes utiles**

   ```sql
   -- CHECK constraint
   ALTER TABLE produits
   ADD CONSTRAINT prix_positif CHECK (prix > 0);

   -- Exclusion constraint
   CREATE TABLE reservations (
       salle TEXT,
       periode TSRANGE,
       EXCLUDE USING GIST (salle WITH =, periode WITH &&)
   );
   ```

3. **Types personnalis√©s**

   ```sql
   -- Cr√©er un type ENUM
   CREATE TYPE statut_commande AS ENUM ('en_attente', 'traitement', 'exp√©di√©', 'livr√©');

   -- Cr√©er un domaine
   CREATE DOMAIN email AS TEXT CHECK (VALUE ~ '^[^@]+@[^@]+\.[^@]+$');
   ```

</Tab>
</Tabs>

## üìö Ressources Utiles

- [Documentation officielle PostgreSQL](https://www.postgresql.org/docs/)
- [PostgreSQL Wiki](https://wiki.postgresql.org/)
- [PgTune - Optimisation de configuration](https://pgtune.leopard.in.ua/)
- [EXPLAIN Visualizer](https://explain.depesz.com/)

---

_Ce guide est un document vivant. N'h√©sitez pas √† le compl√©ter avec vos propres d√©couvertes et cas d'usage !_
